<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="The Diary of Philemon Morriss">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="javascripts/jquery-1.11.2.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>

    <title>The Diary of Philemon Morriss</title>
    <style type="text/css">
    #diary-entries { height: 1200px; overflow: auto; }
    #diary-page { overflow: auto; }
    #map-canvas, #map-canvas2 { height: 600px; width:100%; margin: 0; padding: 0}
    table, tbody, thead, tr, th, td {
       margin: 0;
       padding: 0;
       border: 0;
     }
    </style>
    <script type="text/javascript" src="javascripts/transcription.js"></script>
    <script type="text/javascript" src="javascripts/oregon_trail.js"></script>
    <script type="text/javascript" src="javascripts/wyomingtrails.js"></script>
    <script type="text/javascript"
     src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAF3PMeM_Cxy8SZe8ulcSLrKwQ8QtBT7lY">
    </script>
    <script type="text/javascript">
    var map;
    var map2;
    var markers = [];
    var markersMap = {};
    function pad(num, size) {
       var s = num+"";
       while (s.length < size) s = "0" + s;
       return s;
     };
     function set_page(j) {
       var entry = diarydata.entries[j];
       var baseurl = "https://raw.githubusercontent.com/cmaes/philemonandminerva/master/diary-scan/"
       var url = baseurl + entry.pages[0] + ".jpg";
       $('#diary-page').html("<a href='" + url + "'><img src='" + url + "' height='600'/></a>");
     };
     function set_marker(j) {
        var i;
        var marker = markersMap[j];
        for (i = 0; i < markers.length; i++) {
             markers[i].setIcon('http://maps.google.com/mapfiles/marker.png');
        }
        if (marker) {
           marker.setIcon('http://maps.google.com/mapfiles/ms/icons/yellow-dot.png');
           map.panTo(marker.position);
           map.setZoom(10);
        }
     };
    function initialize() {
       var mapOptions = {
         center: { lng:-109.054378, lat: 42.881179},
         zoom: 4,
         minZoom: 4,
         mapTypeId: google.maps.MapTypeId.TERRAIN
        };
       map = new google.maps.Map(document.getElementById('map-canvas'),
            mapOptions);
       var features = oregon_trail_1.features.filter(function(d) {
                                         if (d.geometry.type == "Point") {
                                             return false;
                                         } else {
                                             return true;
                                         }
                                      });
       oregon_trail_1.features = features;
       features = oregon_trail_2.features.filter(function(d) {
                                         if (d.geometry.type == "Point") {
                                             return false;
                                         } else {
                                             return true;
                                         }
                                      });
       oregon_trail_2.features = features;

       map.data.addGeoJson(oregon_trail_1);
       map.data.addGeoJson(oregon_trail_2);
       map.data.addGeoJson(wyoming_trails);

       var geojson = {"type": "FeatureCollection",
                          "crs": { "type": "name",
                                    "properties": { "name": "urn:ogc:def:crs:OGC:1.3:CRS84" }
                                   },
                          "features": [
                           { "type": "Feature", "properties": { "AREA": 13812708.899650, "PERIMETER": 16170.964430, "DLCPOLY_": 610, "DLCPOLY_ID": 3578, "TWN": "9S", "RNG": "1E", "DLC_": "54", "DLC_NUM": "DLC #54", "DLC": 54.000000 }, "geometry": { "type": "Polygon", "coordinates": [ [ [ -122.709095854598999, 44.815265480391915 ], [ -122.68879287692954, 44.81521061458659 ], [ -122.688860016586233, 44.808466854399676 ], [ -122.69928888123934, 44.808521838897121 ], [ -122.699252226685246, 44.808067293679493 ], [ -122.70898834686912, 44.806997132891965 ], [ -122.709111982579188, 44.812273278050498 ], [ -122.709095854598999, 44.815265480391915 ] ] ] } }
                           ]}

      map.data.addGeoJson(geojson);

      map.data.setStyle({fillColor: 'orange'});

       map.data.addListener('mouseover', function(event) {
         console.log(event.feature.k);
       });

      var i;
      var locations = [];
      var j;
      var loc;
      for (i = 0; i < diarydata.entries.length; i++) {
        if (diarydata.entries[i].locations) {
           for (j = 0; j < diarydata.entries[i].locations.length; j++) {
               loc = diarydata.entries[i].locations[j];
               loc.entry = i;
               locations.push(loc);
           }
        }
        $('<div class="phil" id="entry' + i + '"><p>' + diarydata.entries[i].entry + '</p></div>').appendTo('#diary-entries');
      }
      $('#entry0').addClass('bg-success');

      $('#diary-entries').scroll(function() {
         $('.phil').removeClass('bg-success').each(function() {
           var idx = +$(this).attr('id').substring(5,10);
           if ($(this).position().top > 0) {
             $(this).addClass('bg-success');
             if (diarydata.entries[idx].locations) {
                console.log(diarydata.entries[idx].locations, idx, $(this).attr('id'));
                set_marker(idx);
             }
             set_page(idx);
             return false; // stops the iteration after the first one on screen
           }
         });
      });

     clickfn = function (j, marker) {
       return function() {
             var i;
             var top = document.getElementById('entry-date').offsetTop;
             set_entry(diarydata.entries[j], j);
             for (i = 0; i < markers.length; i++) {
              markers[i].setIcon('http://maps.google.com/mapfiles/marker.png');
             }
             marker.setIcon('http://maps.google.com/mapfiles/ms/icons/yellow-dot.png');
             window.scrollTo(0, top);
           };
      }

      var marker;
      var infowindow;
      for (i = 0; i < locations.length; i++) {
         j = locations[i].entry;
         marker = new google.maps.Marker({
                       position: new google.maps.LatLng(locations[i].lat, locations[i].lon),
                       map: map,
                       title: locations[i].name,
                       icon:'http://maps.google.com/mapfiles/marker.png'
                     });
         markers.push(marker);
         markersMap[j] = marker;
         google.maps.event.addDomListener(marker, 'click', clickfn(j, marker));
      }
      };

      google.maps.event.addDomListener(window, 'load', initialize);

     function set_entry(entry, i) {
       var baseurl = "https://raw.githubusercontent.com/cmaes/philemonandminerva/master/diary-scan/";
       var url = baseurl + entry.pages[0] + ".jpg";
       $('#diary-entry').text(entry.entry);
       $('#entry-date').text(entry.date);
       $('#entry-page').html("Page " + entry.pages[0] + "<br/>" +
                             "<a href='" + url + "'><img src='" + url + "' width='600px'/></a>" +
                             "<div style='float:left'><a href='" + baseurl + pad(+entry.pages[0]-1,2) + ".jpg'>Previous page</a><br><a href='#entry-date' onclick='set_entry(diarydata.entries[" + (+i-1) +"]," + (+i-1) + ")'>Previous entry</a></div>" +
                             "<div style='float:right'><a href='" + baseurl + pad(+entry.pages[0]+1,2) + ".jpg'>Next page</a><br><a href='#entry-date' onclick='set_entry(diarydata.entries[" + (+i+1) + "]," + (+i+1) + ")'>Next entry</a></div>");
     }


    </script>
  </head>
  <body>
  <div class="container-fluid">
    <h1>Philemon Morriss's Oregon Trail Diary</h1>
    <p>Philemon kept a detailed account of his trip west on the Oregon
      Trail, and his first two winters in Oregon, in the small diary shown
      below. You can view <a href="https://github.com/cmaes/philemonandminerva/tree/master/diary-scan">scans of the original diary</a> (made by <a href="https://github.com/cmaes/philemonandminerva/blob/master/diary-scan/info.md">Gary Barker</a>) as
      well as a <a href="https://raw.githubusercontent.com/cmaes/philemonandminerva/master/diary-transcribed/transcription.txt">transcript</a> created by The End of the Oregon Trail Interperative Center.
    </p>
    <div class="row">
    <div class="col-md-6">
    <div id="map-canvas">
    </div>
    <div id="diary-page">
    </div>
    </div>
    <div class="col-md-6">
    <div id="diary-entries">
    </div>
    </div>
    </div>
    <h3>Got Questions or More Information?</h3>
    Please email Chris Maes (cmmaes@gmail.com), descendant of Philemon Morriss, or Emma Siemasko (emmafaye@gmail.com), his beautiful girlfriend.
  </div>
  </body>
<script>
(function() {
 var num2month = { '01': 'january',
                   '02': 'february',
                   '03': 'march',
                   '04': 'april',
                   '05': 'may',
                   '06': 'june',
                   '07': 'july',
                   '08': 'august',
                   '09': 'september',
                   '10': 'october',
                   '11': 'november',
                   '12': 'december' };

 var find_day = function (id, day) {
   $('#' + id + ' td').each(function() {
     if (+$(this).text() === day) {
       return this;
     }
   });
 }

 var i;
 var entries = diarydata.entries;
 var dater;
 var month;
 var year;
 var id;
 var element;
 var node;
 for (i = 0; i < entries.length; i++) {
   dater = entries[i].date;
   day   = parseInt(dater.slice(3,5), 10);
   year  = dater.slice(6,10);
   month = dater.slice(0,2);
   id = num2month[month] + year;
   element = document.getElementById(id);
   if (element) {
     $('#' + id + ' td').each(function() {
       if (+$(this).text() === day) {
         $(this).html("<a href='#entry-date' onclick='set_entry(diarydata.entries[" + i + "]," + i + ")'>" + day + "</a>");
       }
     });
   }
 }
 //set_entry(diarydata.entries[0], 0);
 set_page(0);

})();

</script>
</html>
